plugins {
    id 'java'
    id 'org.springframework.boot' version "${springBootVersion}"
    id 'io.spring.dependency-management' version '1.1.7'
    id 'com.google.cloud.tools.jib' version "${jibVersion}"
    id 'com.diffplug.spotless' version "${spotlessVersion}"
    id 'net.ltgt.errorprone' version "${errorProneVersion}"
    id 'jacoco'
    id 'org.sonarqube' version "${sonarqubeVersion}"
}

group = 'com.accountabilityatlas'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

repositories {
    mavenCentral()
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"
    }
}

dependencies {
    // Spring Cloud Gateway (reactive)
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'

    // JWT
    implementation "io.jsonwebtoken:jjwt-api:${jjwtVersion}"
    runtimeOnly "io.jsonwebtoken:jjwt-impl:${jjwtVersion}"
    runtimeOnly "io.jsonwebtoken:jjwt-jackson:${jjwtVersion}"

    // Redis for rate limiting (future)
    implementation 'org.springframework.boot:spring-boot-starter-data-redis-reactive'

    // Actuator for health checks
    implementation 'org.springframework.boot:spring-boot-starter-actuator'

    // Lombok
    compileOnly "org.projectlombok:lombok:${lombokVersion}"
    annotationProcessor "org.projectlombok:lombok:${lombokVersion}"
    testCompileOnly "org.projectlombok:lombok:${lombokVersion}"
    testAnnotationProcessor "org.projectlombok:lombok:${lombokVersion}"

    // Error Prone
    errorprone "com.google.errorprone:error_prone_core:${errorProneCoreVersion}"

    // Testing
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'io.projectreactor:reactor-test'
    testImplementation "org.testcontainers:testcontainers:${testcontainersVersion}"
    testImplementation "org.testcontainers:junit-jupiter:${testcontainersVersion}"
}

// ---- Spotless ----
spotless {
    java {
        googleJavaFormat()
        removeUnusedImports()
        trimTrailingWhitespace()
        endWithNewline()
    }
}

// ---- Error Prone ----
tasks.withType(JavaCompile).configureEach {
    options.errorprone {
        disableWarningsInGeneratedCode = true
    }
    if (name == 'compileJava') {
        options.compilerArgs += ['-Xlint:-processing']
    }
}

// ---- JaCoCo ----
jacocoTestReport {
    dependsOn test
}

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.80
            }
        }
    }
}

check.dependsOn jacocoTestCoverageVerification

// ---- SonarCloud ----
sonar {
    properties {
        property 'sonar.projectKey', 'kelleyglenn_AcctAtlas-api-gateway'
        property 'sonar.projectName', 'AcctAtlas-api-gateway'
        property 'sonar.organization', 'kelleyglenn'
        property 'sonar.host.url', 'https://sonarcloud.io'
    }
}

// ---- Jib ----
jib {
    from {
        image = 'eclipse-temurin:21-jre-alpine'
    }
    to {
        image = 'acctatlas/api-gateway'
        tags = [version, 'latest']
    }
    container {
        mainClass = 'com.accountabilityatlas.gateway.GatewayApplication'
        ports = ['8080']
        jvmFlags = ['-Djava.security.egd=file:/dev/./urandom']
    }
}

// ---- Custom Tasks ----
tasks.register('composeUp', Exec) {
    group = 'docker'
    description = 'Build Docker image and start all services via docker-compose'
    dependsOn 'jibDockerBuild'
    commandLine 'docker-compose', '--profile', 'app', 'up', '-d'
}

tasks.register('composeDown', Exec) {
    group = 'docker'
    description = 'Stop all services via docker-compose'
    commandLine 'docker-compose', '--profile', 'app', 'down'
}

// ---- Test Config ----
tasks.withType(Test).configureEach {
    useJUnitPlatform()
    jvmArgs '-XX:+EnableDynamicAgentLoading'
}

// ---- Local Development ----
bootRun {
    args = ['--spring.profiles.active=local']
}
